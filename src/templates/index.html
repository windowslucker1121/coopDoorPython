<!DOCTYPE html>
<html>
<head>
    <title>Dinky Coop</title>
    <meta name="theme-color" content="#317EFB"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
    <link rel="icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
    <link rel="icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_144x144.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_192x192.png')}}" type="image/png">
    <link rel="apple-touch-icon" href="{{url_for('static', filename='icons/icon_512x512.png')}}" type="image/png">
    <link rel="manifest" href="/manifest.json">
    <style>
        .title {
            padding: 15px 0px 0px 11px;
            color: #222222;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 600px) {
            .container {
                padding: 0;
            }
        }

        .toggle-container {
            padding: 0px;
            display: flex;
            align-items: center;
        }

        .toggle {
            width: 50px;
            height: 25px;
            background-color: #aaa;
            border-radius: 25px;
            position: relative;
            cursor: pointer;
        }

        .toggle:before {
            content: "";
            position: absolute;
            top: 1px;
            left: 1px;
            width: 23px;
            height: 23px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle.on {
          background-color: #90d590;
        }

        .toggle.on:before {
            transform: translateX(25px);
        }

        .toggle-label {
            margin-left: 10px;
            font-size: 20px;
        }

        .auto_info {
          display: none;
        }

        .auto_info.on {
          display: block;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
        }

        td:first-child {
            width: 35%;
        }

        th, td {
            padding: 15px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            color: #444444;
        }

        th {
            background-color: #f2f2f2;
            color: #555;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .button {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }

        .button.reference {
            background-color: #ff8c00;
        }
        .button.stop {
            background-color: #ff6f6f;
        }

        .button.open {
            background-color: #90d590;
        }

        .button.close {
            background-color: #999;
        }

        .button:last-child {
            margin-right: 0;
        }

        .button:hover {
            opacity: 0.8;
        }

        .capitalize {
            text-transform: capitalize;
        }
    </style>
    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register("/sw.js").then(function(registration) {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
              console.log('ServiceWorker registration failed: ', err);
            });
          });
        }
      </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
    <script>
        var socket = io();

        let current_state = ""

        socket.on('data', function(data) {
            console.log('Received data:', data);
            document.getElementById('temp_in').textContent = data.temp_in;
            document.getElementById('temp_in_min').textContent = data.temp_in_min;
            document.getElementById('temp_in_max').textContent = data.temp_in_max;
            document.getElementById('hum_in').textContent = data.hum_in;
            document.getElementById('hum_in_min').textContent = data.hum_in_min;
            document.getElementById('hum_in_max').textContent = data.hum_in_max;
            document.getElementById('temp_out').textContent = data.temp_out;
            document.getElementById('temp_out_min').textContent = data.temp_out_min;
            document.getElementById('temp_out_max').textContent = data.temp_out_max;
            document.getElementById('hum_out').textContent = data.hum_out;
            document.getElementById('hum_out_min').textContent = data.hum_out_min;
            document.getElementById('hum_out_max').textContent = data.hum_out_max;
            document.getElementById('cpu_temp').textContent = data.cpu_temp;
            document.getElementById('cpu_temp_min').textContent = data.cpu_temp_min;
            document.getElementById('cpu_temp_max').textContent = data.cpu_temp_max;
            document.getElementById('uptime').textContent = data.uptime;
            document.getElementById('sunrise').textContent = data.sunrise;
            document.getElementById('sunset').textContent = data.sunset;
            document.getElementById('tu_open').textContent = data.tu_open;
            document.getElementById('tu_close').textContent = data.tu_close;
            
            var reference = document.getElementById('reference_door_endstops_ms');
            if (reference) {
                reference.textContent = data.reference_door_endstops_ms;
            }
            var isAutoMode = data.auto_mode === "True";
            var container = document.getElementById('auto_info');
            container.style.display = isAutoMode ? "block" : "none";
            //set toggled state
            var toggle = document.getElementById('toggle');
            if (isAutoMode) {
                toggle.classList.add('on');
            } else {
                toggle.classList.remove('on');
            }
            document.getElementById('reference_buttons_div').style.display = data.reference_door_endstops_ms != "Not set" ? "none" : "block";
            if (data.override !== "off") {
                if (current_state !== (data.override + ".switch")) {
                    document.getElementById('state').innerHTML = `<center><img src="static/${data.override}.png" alt="${data.override}" width="90px"><br>${data.override} (via switch)</center>`;
                    current_state = data.override + ".switch";
                }
            } else {
                if (current_state !== data.state) {
                    document.getElementById('state').innerHTML = `<center><img src="static/${data.state}.png" alt="${data.state}" width="90px"><br>${data.state}</center>`;
                    current_state = data.state;
                }
            }
            let error = data.errorstate;
            if (error) {
                document.getElementById('error_section').style.display = "block";
                document.getElementById('errorMessage').textContent = error;
            } else {
                document.getElementById('error_section').style.display = "none";
            }
        });

        socket.on('log', function(data) {
            console.log('Received log:', data);
            const logsDiv = document.getElementById('logs');
            const newLog = document.createElement('div');
            newLog.textContent = data.message;
            logsDiv.appendChild(newLog);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        });

        socket.on('camera', function(data) {
            const webcamFeed = document.getElementById('webcamFeed');
            if (webcamFeed) {
                webcamFeed.src = 'data:image/jpeg;base64,' + data;
            } else {
                console.error('Element with ID "webcamFeed" not found.');
            }
        });

        function sendOpenCommand() {
            socket.emit('open');
        }

        function sendCloseCommand() {
            socket.emit('close');
        }

        function sendStopCommand() {
            socket.emit('stop');
        }

        function clearErrorCommand() {
            socket.emit('clear_error');
        }

        function sendReferenceCommand() {
            socket.emit('reference_endstops');
            var container = document.getElementById('reference_buttons_div');
            container.style.display = "none";
        }

        function toggleSwitch() {
            var toggle = document.getElementById('toggle');
            toggle.classList.toggle('on');
            var isOn = toggle.classList.contains('on');
            console.log('Toggled:', isOn);
            socket.emit('toggle', { toggle: isOn });
            var container = document.getElementById('auto_info');
            if(isOn) {
                container.style.display = "block";
            } else {
                container.style.display = "none";
            }
        }

        // Function to handle form submission
        function handleSubmit(event) {
            event.preventDefault();

            // Get the values from the input boxes
            const sunrise_offset = document.getElementById('sunrise_offset').value;
            const sunset_offset = document.getElementById('sunset_offset').value;

            // Send the values to the Flask app via WebSocket
            socket.emit('auto_offsets', { sunrise_offset, sunset_offset });
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="content">
            <h1>Coop Door</h1>
            <div id="error_section" class="collapsible">
                <h3 class="title" onclick="toggleSection('errorSection')">Error State Active</h3>
                <div id="errorSection" class="content-section">
                    <table>
                        <tr id="reference_buttons_div">
                            <td><b>Current Error:</b></td>
                            <td id="errorMessage">none</td>
                            <td><button class="button reference" onclick="clearErrorCommand()">Clear Error</button></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('webcam_section')">Webcam Livefeed</h3>
                <div id="webcam_section" class="content-section">
                    <img id="webcamFeed" src="static/waiting.png" style="width: 100%; height: auto;">
                </div>
            </div>
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('door_control')">Door Control</h3>
                <div id="door_control" class="content-section">
                    <table>
                        <tr id="reference_buttons_div">
                            <td><b>Reference Endstops Travel Time in Milliseconds:</b></td>
                            <td><span id="reference_door_endstops_ms"></span></td>
                            <td><button class="button reference" onclick="sendReferenceCommand()">Trigger Reference Sequence</button></td>
                        </tr>
                        <tr>
                            <td>
                                <span id="state"></span>
                                <div class="button-container" style="margin-top: 20px;">
                                    <button class="button close" onclick="sendCloseCommand()">Close</button>
                                    <button class="button stop" onclick="sendStopCommand()">Stop</button>
                                    <button class="button open" onclick="sendOpenCommand()">Open</button>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="toggle-container" style="margin-bottom: 0px;">
                        <h4 class="title" style="margin-right: 20px; margin-top: 10px;">Auto Mode</h3>
                        <div class="toggle{% if auto_mode %} on{% endif %}" id="toggle" onclick="toggleSwitch()"></div>
                    </div>
                    <div id="auto_info" class="auto_info {% if auto_mode %} on{% endif %}">
                        <table style="margin-top: 0px;">
                            <tr>
                                <td colspan="2">
                                    <form onsubmit="handleSubmit(event)">
                                        <label for="sunrise_offset">Open door at sunrise plus </label>
                                        <input type="number" id="sunrise_offset" name="sunrise_offset" step="1" maxlength="4" style="width: 50px;" value={{ sunrise_offset }} required>
                                        <label> minutes.</label><br/>
            
                                        <label for="sunset_offset">Close door at sunset plus </label>
                                        <input type="number" id="sunset_offset" name="sunset_offset" step="1" maxlength="4" style="width: 50px;" value={{ sunset_offset }} required>
                                        <label> minutes.</label><br/>
            
                                        <div class="button-container" style="margin-top: 20px;">
                                            <button class="button open" type="submit">Save</button>
                                        </div>
                                    </form>
                                </td>
                            <tr>
                                <td><b>Sunrise</b></td>
                                <td><span id="sunrise"></span></td>
                            </tr>
                            <tr>
                                <td><b>Sunset</b></td>
                                <td><span id="sunset"></span></td>
                            </tr>
                            <tr>
                                <td><b>Door Opens in</b></td>
                                <td><span id="tu_open"></span></td>
                            </tr>
                            <tr>
                                <td><b>Door Closes in</b></td>
                                <td><span id="tu_close"></span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('system')">System</h3>
                <div id="system" class="content-section">
                    <table>
                        <tr>
                            <td><b>Uptime</b></td>
                            <td colspan="3"><span id="uptime"></span></td>
                        </tr>
                        <tr>
                            <td><b>CPU Temperature</b></td>
                            <td><span id="cpu_temp_min" style="color: #0d98ba;"></span></td>
                            <td><span id="cpu_temp" style="font-weight: bold;"></span></td>
                            <td><span id="cpu_temp_max" style="color: #ff8c00;"></span></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('temperature')">Temperature</h3>
                <div id="temperature" class="content-section">
                    <h4 class="title">Inside</h2>
                    <table>
                        <tr>
                            <td><b>Temperature</b></td>
                            <td><span id="temp_in_min" style="color: #0d98ba;"></span></td>
                            <td><span id="temp_in" style="font-weight: bold;"></span></td>
                            <td><span id="temp_in_max" style="color: #ff8c00;"></span></td>
                        </tr>
                        <tr>
                            <td><b>Humidity</b></td>
                            <td><span id="hum_in_min" style="color: #0d98ba;"></span></td>
                            <td><span id="hum_in" style="font-weight: bold;"></span></td>
                            <td><span id="hum_in_max" style="color: #ff8c00;"></span></td>
                        </tr>
                    </table>
                <!-- Outside Section -->
            
                    <h4 class="title">Outside</h3>
                    <table>
                        <tr>
                            <td><b>Temperature</b></td>
                            <td><span id="temp_out_min" style="color: #0d98ba;"></span></td>
                            <td><span id="temp_out" style="font-weight: bold;"></span></td>
                            <td><span id="temp_out_max" style="color: #ff8c00;"></span></td>
                        </tr>
                        <tr>
                            <td><b>Humidity</b></td>
                            <td><span id="hum_out_min" style="color: #0d98ba;"></span></td>
                            <td><span id="hum_out" style="font-weight: bold;"></span></td>
                            <td><span id="hum_out_max" style="color: #ff8c00;"></span></td>
                        </tr>
                    </table>            
            </div>
       
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('location')">Location</h3>
                <div id="location" class="content-section">
                    <h4>Select one of the available Locations</h4>
                    <select id="predefined-locations" onchange="populateLocationFields()">
                        <option value="" disabled selected>Select a location...</option>
                        {% for loc in valid_locations %}
                        <option value="{{ loc.name }}"
                            data-region="{{ loc.region }}"
                            data-timezone="{{ loc.timezone }}"
                            data-latitude="{{ loc.latitude }}"
                            data-longitude="{{ loc.longitude }}">
                            {{ loc.name }} ({{ loc.region }}, {{ loc.timezone }})
                        </option>
                        {% endfor %}
                    </select>

                    <h4>or enter it manually: </h4>
                    <form onsubmit="handleLocationSubmit(event)">
                        <label for="city">City:</label>
                        <input type="text" id="city" name="city" value="{{ location.city if location else '' }}" required><br>
            
                        <label for="region">Region:</label>
                        <input type="text" id="region" name="region" value="{{ location.region if location else '' }}" required><br>
            
                        <label for="timezone">Timezone:</label>
                        <input type="text" id="timezone" name="timezone" value="{{ location.timezone if location else '' }}" required><br>
            
                        <label for="latitude">Latitude:</label>
                        <input type="number" step="0.000001" id="latitude" name="latitude" value="{{ location.latitude if location else '' }}" required><br>
            
                        <label for="longitude">Longitude:</label>
                        <input type="number" step="0.000001" id="longitude" name="longitude" value="{{ location.longitude if location else '' }}" required><br>
            
                        <div class="button-container" style="margin-top: 20px;">
                            <button class="button open" type="submit">Save</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="collapsible">
                <h3 class="title" onclick="toggleSection('logSection')">Server Logs</h3>
                <div id="logSection" class="container">
                    <div class="content">
                        <div id="logs" style="height: 300px; overflow-y: auto; background: #f9f9f9; padding: 0px; border: 1px solid #ccc; border-radius: 5px;">
                        </div>
                    </div>
                </div>
            </div>
            <script>
                function populateLocationFields() {
                    const dropdown = document.getElementById('predefined-locations');
                    const selectedOption = dropdown.options[dropdown.selectedIndex];
                    if (selectedOption) {
                        document.getElementById('city').value = selectedOption.value;
                        document.getElementById('region').value = selectedOption.getAttribute('data-region');
                        document.getElementById('timezone').value = selectedOption.getAttribute('data-timezone');
                        document.getElementById('latitude').value = selectedOption.getAttribute('data-latitude');
                        document.getElementById('longitude').value = selectedOption.getAttribute('data-longitude');
                    }
                }

                function handleLocationSubmit(event) {
                    event.preventDefault();

                    const city = document.getElementById('city').value;
                    const region = document.getElementById('region').value;
                    const timezone = document.getElementById('timezone').value;
                    const latitude = parseFloat(document.getElementById('latitude').value);
                    const longitude = parseFloat(document.getElementById('longitude').value);

                    // Send the location data to the server via WebSocket
                    socket.emit('update_location', { city, region, timezone, latitude, longitude });
                }
            </script>
                   
        </div>
    </div>

    <script>
        function toggleSection(id) {
            const section = document.getElementById(id);
            if (section.style.display === "none" || !section.style.display) {
                section.style.display = "block";
            } else {
                section.style.display = "none";
            }
        }

        // Initialize all sections as collapsed
        document.querySelectorAll('.content-section').forEach(section => {
            section.style.display = "block";
        });
    </script>

    <style>
        .collapsible h3 {
            cursor: pointer;
            padding: 10px;
            margin: 0;
            background-color: #f9f9f9; /* Light background for better visibility */
            border: 1px solid #ccc; /* Border around the header */
            border-radius: 5px; /* Rounded corners for a softer look */
        }

        .collapsible h3:hover {
            background-color: #e9e9e9; /* Slightly darker on hover */
        }

        .content-section {
            display: none; /* Initially collapsed */
            padding: 10px;
            border: 1px solid #ccc; /* Border for the content */
            border-top: none; /* Avoid double border between header and content */
            border-radius: 0 0 5px 5px; /* Rounded bottom corners */
            background-color: #fff; /* White background for content */
        }
    </style>

</body>

</html>
